<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>دفتر حساب ارز دیجیتال پیشرفته</title>
<style>
body {
  font-family: Tahoma, sans-serif;
  background: #111;
  color: #eee;
  margin: 20px auto;
  max-width: 800px;
  padding: 0 10px 40px; 
}
h2, h3 { color: #0f0; text-align: center; margin-top: 25px; }
h2 { margin-bottom: 30px; }

/* === استایل‌های عمومی فرم === */
.form-container {
  display: flex;
  flex-wrap: wrap;
  gap: 10px; 
  padding: 15px;
  background: #222;
  border-radius: 8px;
  margin-bottom: 20px;
}
.form-item {
  flex: 1 1 45%; 
  min-width: 150px;
}
.full-width { flex: 1 1 100%; }

label {
  display: block; 
  margin-bottom: 4px; 
  font-weight: bold; 
  font-size: 14px;
}
select, input:not([type="file"]), button {
  display: block; 
  width: 100%; 
  font-size: 14px;
  padding: 8px; 
  border-radius: 6px; 
  border: none; 
  box-sizing: border-box;
  margin-top: 0; 
}
input:not([type="file"]) { background: #333; color: #eee; }

button { 
  background-color: #0f0; 
  color: #000; 
  font-weight: bold; 
  cursor: pointer;
  transition: background-color 0.2s;
}
button:hover { background-color: #0c0; }

#submitBtn { margin-top: 20px; padding: 10px; }

/* === بخش خلاصه بالا (Header) === */
.top-summary {
    background: #222;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 20px;
    border: 1px solid #444;
}
.summary-line {
    display: flex;
    justify-content: space-between;
    padding: 5px 0;
    border-bottom: 1px dashed #333;
}
.summary-line:last-child {
    border-bottom: none;
    font-size: 1.1em;
}
.summary-label {
    color: #aaa;
    font-weight: normal;
}
.summary-value {
    font-weight: bold;
    color: #fff;
    direction: ltr; /* برای نمایش عدد و واحد به صورت انگلیسی */
    text-align: left;
}
#total-assets-display-value { color: orange; font-size: 1.2em; }
#last-updated { font-size: 0.7em; color: #aaa; margin-top: 10px; text-align: center; }
.profit-text { color: #0f0 !important; }
.loss-text { color: #f33 !important; }

/* === بخش ورودی سرمایه/نقد === */
.input-summary-section {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin-bottom: 20px;
    padding: 10px;
    background: #333;
    border-radius: 8px;
}
.input-summary-box {
    flex: 1 1 45%;
    min-width: 200px;
    padding: 5px;
}
.input-group { 
    display: flex; 
    align-items: center; 
    margin-top: 5px; 
    gap: 5px;
}
.input-summary-box input { margin: 0; text-align: center; padding: 6px; font-size: 13px; }
.input-summary-box button { width: auto; padding: 6px 10px; font-size: 12px; margin: 0; flex-shrink: 0; }

/* === استایل‌های جدول === */
.table-container {
  overflow-x: auto; 
  margin-top: 15px; 
  background: #222;
  border-radius: 6px; 
  padding: 5px; 
  animation: slide-in 0.5s ease;
}
@keyframes slide-in { from { opacity: 0; } to { opacity: 1; } }

.table-container table {
  width: 100%; 
  border-collapse: collapse; 
  min-width: 750px; /* افزایش عرض برای جای دادن ستون‌های جدید و داده‌ها */
}
.table-container th,
.table-container td {
  border: 1px solid #444; 
  padding: 3px 5px;   /* کاهش پدینگ */
  font-size: 13px;    
  text-align: center; 
  word-break: break-word; 
  line-height: 1.4;  
}
.table-container th { background-color: #333; }
.table-container tbody tr:hover { background-color: #333a; }

/* === عرض ستون نوع === */
.type-cell {
    width: 60px; 
    font-weight: bold;
}

/* === دکمه‌های عملیات جدول === */
.actions-cell {
  white-space: nowrap; 
  width: 1px; 
}
.actions-cell button {
  display: inline-block;
  width: auto;
  padding: 2px 5px;     
  font-size: 10px;       
  height: auto;         
  margin: 1px;
  border-radius: 4px;
}
button.edit { background-color: orange; color: black; }
button.delete { background-color: red; color: white; }

/* === رنگ‌های سود و زیان جدول === */
.profit { color: #0f0; font-weight: bold; }
.loss { color: #f33; font-weight: bold; }
.buy { color: #0ff; }
.sell { color: #f0f; }

/* === سایر استایل‌ها === */
#costDisplay { color:#0f0; font-weight:bold; margin-top:-5px; margin-bottom:12px; text-align: center; }
#searchInput { background: #333; margin-top: 10px; }

/* === رسپانسیو برای موبایل === */
@media (max-width: 600px) {
  body { margin: 5px; padding: 0 5px 40px; }
  .form-container { flex-direction: column; }
  .form-item { min-width: 100%; }
  .table-container table { min-width: 500px; } 
  .table-container th,
  .table-container td { padding: 3px 6px; font-size: 12px; }
  .actions-cell button { font-size: 9px; padding: 1px 4px; }
  .input-summary-section { flex-direction: column; }
  .input-summary-box { min-width: 100%; }
}
</style>
</head>
<body>

<h2>📒 دفتر حساب ارز دیجیتال پیشرفته</h2>

<div class="top-summary">
    <div class="summary-line">
        <span class="summary-label">سرمایه‌گذاری اولیه (USDT):</span>
        <span class="summary-value" id="investment-display-value">0 USDT</span>
    </div>
    <div class="summary-line">
        <span class="summary-label">تتر نقد (USDT):</span>
        <span class="summary-value" id="cash-display-value">0 USDT</span>
    </div>
    <div class="summary-line">
        <span class="summary-label">ارزش کل دارایی‌ها (USDT) 💰:</span>
        <span class="summary-value" id="total-assets-display-value">0 USDT</span>
    </div>
    <div class="summary-line">
        <span class="summary-label">سود/زیان کل (USDT) 📈:</span>
        <span class="summary-value" id="total-profit-value">0 USDT</span>
    </div>
    <div class="summary-line">
        <span class="summary-label">درصد سود/زیان کل (%):</span>
        <span class="summary-value" id="total-profit-percent">0%</span>
    </div>
    <div id="last-updated">آخرین به‌روزرسانی قیمت‌ها: -</div>
</div>

<div class="input-summary-section">
  <div class="input-summary-box">
    <label for="investment-input">بروزرسانی سرمایه‌گذاری اولیه</label>
    <div class="input-group">
      <input type="number" id="investment-input" placeholder="مبلغ کل سرمایه">
      <button onclick="updateHeaderValue('investment')">ثبت</button>
    </div>
  </div>
  <div class="input-summary-box">
    <label for="cash-input">بروزرسانی تتر نقد</label>
    <div class="input-group">
      <input type="number" id="cash-input" placeholder="موجودی تتر نقد">
      <button onclick="updateHeaderValue('cash')">ثبت</button>
    </div>
  </div>
</div>

<div class="form-container">
  <div class="form-item">
    <label for="coin">انتخاب ارز:</label>
    <select id="coin">
      <option value="BTC">BTC</option>
      <option value="ETH">ETH</option>
      <option value="CRV">CRV</option>
      <option value="ADA">ADA</option>
      <option value="DOGE">DOGE</option>
            <option value="PUMP">PUMP</option>
      <option value="BLUM">BLUM</option>
        <option value="BLUM1">BLUM1</option>

    </select>
  </div>
  <div class="form-item">
    <label for="type">نوع تراکنش:</label>
    <select id="type">
      <option value="buy">خرید</option>
      <option value="sell">فروش</option>
    </select>
  </div>
  <div class="form-item">
    <label for="price">قیمت واحد (USDT):</label>
    <input type="number" id="price" placeholder="قیمت واحد" step="0.0001" min="0">
  </div>
  <div class="form-item">
    <label for="usdt-amount">مقدار تتر (USDT):</label>
    <input type="number" id="usdt-amount" placeholder="مقدار USDT" step="0.01" min="0">
  </div>
  <div class="form-item">
    <label for="amount">تعداد توکن:</label>
    <input type="number" id="amount" placeholder="تعداد" step="0.0001" min="0">
  </div>
  <div class="form-item full-width">
    <label for="date-input">تاریخ و ساعت تراکنش:</label>
    <input type="datetime-local" id="date-input" />
  </div>

  <div id="costDisplay" class="full-width">قیمت تمام شده: 0</div>
  
  <div class="form-item full-width">
    <button id="submitBtn">ثبت تراکنش</button>
  </div>

  <div class="form-item">
    <button id="backupBtn">دانلود پشتیبان</button>
  </div>
  <div class="form-item">
    <input type="file" id="restoreFile" style="display:none" accept=".json" />
    <button id="restoreBtn">بارگذاری پشتیبان</button>
  </div>
</div>

<h3>جستجو در تراکنش‌ها (بر اساس ارز):</h3>
<input type="text" id="searchInput" placeholder="نام ارز را تایپ کنید ...">

<div id="transactionsContainer" class="table-container"></div>

<h3>موجودی و میانگین خرید</h3>
<div class="table-container">
<table id="summaryTable">
  <thead>
    <tr>
      <th>ارز</th>
      <th>موجودی</th>
      <th>میانگین خرید</th>
      <th>قیمت تمام شده</th>
      <th>قیمت لحظه‌ای</th>
      <th>ارزش فعلی</th>
      <th>سود/زیان لحظه‌ای</th>
      <th>درصد سود/زیان لحظه‌ای</th>
    </tr>
  </thead>
  <tbody id="summary"></tbody>
</table>
</div>

<script>
// === متغیرهای سراسری ===
let transactions = JSON.parse(localStorage.getItem("transactions") || "[]");
let editIndex = -1;
let prices = {};

// استفاده از Coingecko API
const coinGeckoIds = {
  BTC: "bitcoin", ETH: "ethereum", CRV: "curve-dao-token",
  ADA: "cardano",   DOGE: "dogecoin", PUMP:"pump-fun",
  BLUM: "blum",BLUM1: "blum"
};

/**
 * تعیین رقم اعشار بر اساس قیمت.
 * اگر قیمت > 1 باشد، 2 رقم اعشار.
 * اگر قیمت <= 1 باشد، 5 رقم اعشار.
 */
function getDecimals(price) {
    return price > 1 ? 2 : 5;
}

// === توابع API و داده‌ها ===
async function fetchPrices() {
  const ids = Object.values(coinGeckoIds).join(",");
  try {
    // بازگشت به Coingecko API (بدون نیاز به پروکسی)
    const res = await fetch(`https://api.coingecko.com/api/v3/simple/price?ids=${ids}&vs_currencies=usd`);
    const data = await res.json();
    for (const [key, id] of Object.entries(coinGeckoIds)) {
      prices[key] = data[id]?.usd || 0;
    }
    const now = new Date();
    document.getElementById('last-updated').textContent = `آخرین به‌روزرسانی قیمت‌ها: ${now.toLocaleTimeString('fa-IR', {hour: '2-digit', minute: '2-digit'})}`;
  } catch(error) { 
    console.error("خطا در دریافت قیمت از Coingecko:", error);
    for (const key in coinGeckoIds) prices[key]=0; 
  }
}

function saveData(){ localStorage.setItem("transactions", JSON.stringify(transactions)); }

// *** تابع به‌روز شده برای نمایش قیمت تمام شده ***
function updateCostDisplay() {
  const usdtAmount = parseFloat(document.getElementById("usdt-amount").value);
  const amount = parseFloat(document.getElementById("amount").value);
  
  let cost = 0;
  if (!isNaN(usdtAmount) && usdtAmount > 0) {
    cost = usdtAmount.toFixed(2);
  } else if (!isNaN(amount) && amount > 0) {
    const price = parseFloat(document.getElementById("price").value);
    if (!isNaN(price) && price > 0) {
      cost = (amount * price).toFixed(2);
    }
  }
  
  document.getElementById("costDisplay").textContent = `قیمت تمام شده: ${parseFloat(cost).toLocaleString('fa-IR')} USDT`;
}

// *** تابع جدید: محاسبه تعداد توکن بر اساس مقدار USDT ***
function calculateAmountByUSDT() {
    const usdt = parseFloat(document.getElementById("usdt-amount").value);
    const price = parseFloat(document.getElementById("price").value);
    const amountInput = document.getElementById("amount");
    
    // اگر یکی از مقادیر صفر یا نامعتبر باشد
    if (isNaN(usdt) || usdt <= 0 || isNaN(price) || price <= 0) {
        amountInput.value = '';
        updateCostDisplay();
        return;
    }

    // محاسبه: تعداد توکن = مقدار USDT / قیمت واحد
    const amount = usdt / price;
    
    // اعمال منطق اعشار برای تعداد (حداقل 5 رقم اعشار برای دقت)
    amountInput.value = amount.toFixed(5);
    
    updateCostDisplay();
}

// *** تابع جدید: محاسبه مقدار USDT بر اساس تعداد توکن (برای مدیریت ورودی) ***
function calculateUSDTByAmount() {
    const amount = parseFloat(document.getElementById("amount").value);
    const price = parseFloat(document.getElementById("price").value);
    const usdtInput = document.getElementById("usdt-amount");

    // اگر یکی از مقادیر صفر یا نامعتبر باشد
    if (isNaN(amount) || amount <= 0 || isNaN(price) || price <= 0) {
        usdtInput.value = '';
        updateCostDisplay();
        return;
    }

    // محاسبه: مقدار USDT = تعداد توکن * قیمت واحد
    const usdt = amount * price;

    usdtInput.value = usdt.toFixed(2); // USDT معمولا تا 2 رقم اعشار
    
    updateCostDisplay();
}


// === توابع رندرینگ ===
function renderTransactions(filterText = "") {
  const container = document.getElementById("transactionsContainer");
  container.innerHTML = "";
  
  const grouped = transactions.reduce((acc, t, i) => {
    if(filterText && !t.coin.toLowerCase().includes(filterText.toLowerCase())) return acc;
    if(!acc[t.coin]) acc[t.coin] = [];
    acc[t.coin].push({...t, index: i});
    return acc;
  }, {});
  
  for (const coin in grouped) {
    const tableContainer = document.createElement("div");
    tableContainer.className = "table-container";
    const table = document.createElement("table");
    table.innerHTML = `
      <thead>
        <tr><th colspan="7" style="background:#444;color:#0f0;font-size:1.1em;">${coin}</th></tr>
        <tr>
          <th>تعداد</th><th>قیمت واحد</th><th>قیمت تمام شده</th>
          <th class="type-cell">نوع</th><th>سود/زیان فروش</th><th>تاریخ و ساعت</th><th>عملیات</th>
        </tr>
      </thead>
      <tbody></tbody>`;
    const tbody = table.querySelector("tbody");

    grouped[coin].slice().reverse().forEach(t => {
      const cost = (t.amount * t.price).toFixed(2);
      
      const options = { year: 'numeric', month: 'numeric', day: 'numeric', hour: '2-digit', minute: '2-digit', hour12: false };
      let formattedDate = t.date ? new Date(t.date).toLocaleString("fa-IR", options).replace(',', '<br>') : "-";

      let profitLossSale = "";
      let profitLossClass = "";
      if (t.type === "sell") {
          const { avg } = calculateAvg(t.coin, t.index); 
          if (avg > 0) {
            profitLossSale = ((t.price - avg) * t.amount).toFixed(2);
            profitLossClass = profitLossSale >= 0 ? "profit" : "loss";
          }
      }
      
      // *** اعمال منطق اعشار برای قیمت واحد (t.price) ***
      const priceDecimals = getDecimals(t.price); 

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${t.amount.toFixed(2)}</td>
        <td>${t.price.toFixed(priceDecimals)}</td> 
        <td>${cost.toLocaleString('fa-IR')}</td>
        <td class="type-cell ${t.type}">${t.type === "buy" ? "خرید" : "فروش"}</td>
        <td class="${profitLossClass}">${profitLossSale.toLocaleString('fa-IR')}</td>
        <td>${formattedDate}</td>
        <td class="actions-cell">
          <button class="edit" onclick="editTransaction(${t.index})">ویرایش</button> 
          <button class="delete" onclick="deleteTransaction(${t.index})">حذف</button>
        </td>`;
      tbody.appendChild(tr);
    });

    tableContainer.appendChild(table);
    container.appendChild(tableContainer);
  }

  renderSummary();
}

// محاسبه موجودی و میانگین خرید تا یک نقطه مشخص در لیست تراکنش‌ها
function calculateHoldings(untilIndex = transactions.length) {
    const holdings = {};
    for (let i = 0; i < untilIndex; i++) {
        const t = transactions[i];
        if (!holdings[t.coin]) holdings[t.coin] = { amount: 0, cost: 0 };

        if (t.type === "buy") {
            holdings[t.coin].amount += t.amount;
            holdings[t.coin].cost += t.amount * t.price;
        } else {
            const avg = holdings[t.coin].cost / holdings[t.coin].amount || 0;
            holdings[t.coin].amount -= t.amount;
            holdings[t.coin].cost -= avg * t.amount;
            if (holdings[t.coin].amount < 0.00001) {
                holdings[t.coin].amount = 0;
                holdings[t.coin].cost = 0;
            }
        }
    }
    return holdings;
}

// تابع کمکی برای محاسبه میانگین خرید قبل از یک تراکنش (برای فروش)
function calculateAvg(coin, currentIndex) {
    const holdings = calculateHoldings(currentIndex);
    const amt = holdings[coin]?.amount || 0;
    const cost = holdings[coin]?.cost || 0;
    return { avg: cost / amt || 0, cost, amt };
}

function renderSummary(){
  const tbody=document.getElementById("summary");
  tbody.innerHTML="";
  const holdings=calculateHoldings();

  let totalCost=0,totalValue=0,totalProfit=0;

  for(const coin in holdings){
    const amt = holdings[coin].amount;
    if(amt<=0.00001) continue;
    const avg = holdings[coin].cost/amt;
    const cost = holdings[coin].cost;
    const currentPrice = prices[coin]||0;
    const value = currentPrice * amt;
    const profitLoss = value - cost;
    const profitLossPercent = cost > 0 ? (profitLoss / cost) * 100 : 0;
    const profitLossClass = profitLoss>=0?"profit":"loss";

    totalCost += cost;
    totalValue += value;
    totalProfit += profitLoss;

    // *** اعمال منطق اعشار برای قیمت لحظه‌ای (currentPrice) ***
    const priceDecimals = getDecimals(currentPrice); 

    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td>${coin}</td>
      <td>${amt.toFixed(2)}</td>
      <td>${avg.toFixed(5)}</td>
      <td>${cost.toFixed(2).toLocaleString('fa-IR')}</td>
      <td>${currentPrice.toFixed(priceDecimals).toLocaleString('fa-IR')}</td>
      <td>${value.toFixed(2).toLocaleString('fa-IR')}</td> <td class="${profitLossClass}">${profitLoss.toFixed(2).toLocaleString('fa-IR')}</td>
      <td class="${profitLossClass}">${profitLossPercent.toFixed(2).toLocaleString('fa-IR')}%</td> `;
    tbody.appendChild(tr);
  }

  // محاسبه درصد سود کل دارایی‌های رمزنگاری (بدون احتساب نقدینگی)
  const totalAssetsProfitPercent = totalCost > 0 ? (totalProfit / totalCost) * 100 : 0;

  // جمع کل
  const totalInvestment = parseFloat(localStorage.getItem('investment') || '0');
  const cashValue = parseFloat(localStorage.getItem('cash') || '0');
  const totalAssets = totalValue + cashValue;
  const totalInvestmentProfit = totalAssets - totalInvestment;
  const totalInvestmentProfitPercent = totalInvestment > 0 ? (totalInvestmentProfit / totalInvestment) * 100 : 0;
  
  const totalRow=document.createElement("tr");
  totalRow.style.fontWeight="bold";
  totalRow.style.background="#333";
  totalRow.innerHTML=`
    <td colspan="3">جمع کل دارایی‌ها</td>
    <td>${totalCost.toFixed(2).toLocaleString('fa-IR')}</td> <td>-</td>
    <td>${totalValue.toFixed(2).toLocaleString('fa-IR')}</td> <td class="${totalProfit>=0?"profit":"loss"}">${totalProfit.toFixed(2).toLocaleString('fa-IR')}</td>
    <td class="${totalAssetsProfitPercent>=0?"profit":"loss"}">${totalAssetsProfitPercent.toFixed(2).toLocaleString('fa-IR')}%</td>`; tbody.appendChild(totalRow);
  
  const profitClass = totalInvestmentProfit >= 0 ? 'profit-text' : 'loss-text';

  // به‌روزرسانی مقادیر بالای جدول (خلاصه کلی حساب)
  document.getElementById('total-assets-display-value').textContent = `${totalAssets.toFixed(2).toLocaleString('fa-IR')} USDT`;
  
  // به‌روزرسانی سود کل
  const profitValueEl = document.getElementById('total-profit-value');
  const profitPercentEl = document.getElementById('total-profit-percent');
  
  profitValueEl.textContent = `${totalInvestmentProfit.toFixed(2).toLocaleString('fa-IR')} USDT`;
  profitPercentEl.textContent = `${totalInvestmentProfitPercent.toFixed(2).toLocaleString('fa-IR')}%`;
  
  // تنظیم رنگ سود/زیان
  profitValueEl.className = `summary-value ${profitClass}`;
  profitPercentEl.className = `summary-value ${profitClass}`;

  // لود کردن مجدد مقادیر اصلی برای نمایش
  loadHeaderValues();
}

// === توابع مدیریت تراکنش‌ها ===
function addTransaction(){
  const coin = document.getElementById("coin").value;
  // **مقدار تتر را از فیلد usdt-amount می‌خوانیم**
  let amount = parseFloat(document.getElementById("amount").value);
  let price = parseFloat(document.getElementById("price").value);
  const type = document.getElementById("type").value;
  const dateInput = document.getElementById("date-input").value;
  const usdtAmount = parseFloat(document.getElementById("usdt-amount").value);
  
  // **اولویت با مقدار usdt وارد شده است**
  if (!isNaN(usdtAmount) && usdtAmount > 0) {
      if (isNaN(price) || price <= 0) {
          alert("لطفاً قیمت واحد را وارد کنید.");
          return;
      }
      // محاسبه تعداد بر اساس تتر
      amount = usdtAmount / price;
      // قیمت تمام شده (cost) در اینجا همان usdtAmount است
  }
  
  // **بررسی اعتبار نهایی**
  if(isNaN(amount)||isNaN(price)||amount<=0||price<=0){ 
      alert("مقادیر معتبر (تعداد یا تتر و قیمت) وارد کنید"); 
      return; 
  }

  // **بررسی موجودی برای فروش**
  if(type==="sell"){
    let currentAmount = 0;
    const tempTransactions = editIndex >= 0 ? transactions.filter((_, i) => i !== editIndex) : transactions;
    tempTransactions.forEach(t => {
      if(t.coin === coin) currentAmount += t.type === 'buy' ? t.amount : -t.amount;
    });

    if(amount > currentAmount){ 
      alert(`فروش بیشتر از موجودی مجاز نیست. موجودی شما: ${currentAmount.toFixed(4)}`); 
      return; 
    }
  }

  const date = dateInput ? new Date(dateInput).toISOString() : new Date().toISOString();

  // اطمینان از اینکه amount و price دقیقاً همان چیزی هستند که ثبت می‌کنیم
  const newTransaction = { coin, amount: amount, price: price, type, date };

  if(editIndex>=0){
    transactions[editIndex] = newTransaction;
    editIndex = -1;
    document.getElementById("submitBtn").textContent = "ثبت تراکنش";
  } else { transactions.push(newTransaction); }

  transactions.sort((a, b) => new Date(a.date) - new Date(b.date));

  saveData();
  renderTransactions(document.getElementById("searchInput").value);
  clearForm();
}

function editTransaction(index){
  const t = transactions[index];
  document.getElementById("coin").value = t.coin;
  document.getElementById("amount").value = t.amount;
  document.getElementById("price").value = t.price;
  document.getElementById("type").value = t.type;
  
  // **محاسبه و پر کردن فیلد usdt-amount برای ویرایش**
  document.getElementById("usdt-amount").value = (t.amount * t.price).toFixed(2);
  
  const date = new Date(t.date);
  const offset = date.getTimezoneOffset() * 60000; 
  const localIsoDate = new Date(date.getTime() - offset).toISOString().slice(0, 16);
  document.getElementById("date-input").value = localIsoDate;

  editIndex = index;
  document.getElementById("submitBtn").textContent = "ویرایش تراکنش (ثبت تغییرات)";
  updateCostDisplay();
  window.scrollTo(0, 0); 
}

function deleteTransaction(index){
  if(confirm("آیا از حذف این تراکنش مطمئن هستید؟")){
    transactions.splice(index,1);
    saveData();
    renderTransactions(document.getElementById("searchInput").value);
  }
}

function clearForm(){
  document.getElementById("coin").value="BTC";
  document.getElementById("amount").value="";
  document.getElementById("price").value="";
  document.getElementById("usdt-amount").value=""; // پاک کردن فیلد جدید
  document.getElementById("type").value="buy";
  document.getElementById("date-input").value = "";
  updateCostDisplay();
  editIndex = -1;
  document.getElementById("submitBtn").textContent="ثبت تراکنش";
}

function setPriceByCoin(coin, type){
  const currentPrice = prices[coin] || 0;
  if (currentPrice > 0) {
    // *** اعمال منطق اعشار برای ورودی قیمت ***
    const decimals = getDecimals(currentPrice);
    document.getElementById("price").value = currentPrice.toFixed(decimals); 
  } 
  // **بعد از به‌روزرسانی قیمت، محاسبات را انجام می‌دهیم**
  calculateAmountByUSDT(); 
  updateCostDisplay();
}

// === توابع خلاصه بالا (Header) ===
function updateHeaderValue(type) { 
    const inputEl = document.getElementById(`${type}-input`);
    let value = parseFloat(inputEl.value);

    if (isNaN(value) || value < 0) {
        if(inputEl.value === "") { 
            value = parseFloat(localStorage.getItem(type) || '0');
        } else {
            alert('لطفا یک عدد معتبر وارد کنید.');
            return;
        }
    }
    
    localStorage.setItem(type, value.toFixed(2)); // ذخیره با دقت 2
    inputEl.value = ''; 
    
    renderSummary(); 
}

function loadHeaderValues() {
    const investment = parseFloat(localStorage.getItem('investment') || '0');
    const cash = parseFloat(localStorage.getItem('cash') || '0');

    // نمایش مقادیر در بخش جدید خلاصه بالای جدول
    document.getElementById('investment-display-value').textContent = `${investment.toFixed(2).toLocaleString('fa-IR')} USDT`;
    document.getElementById('cash-display-value').textContent = `${cash.toFixed(2).toLocaleString('fa-IR')} USDT`;
}


// === مقداردهی اولیه ===
async function init(){
  loadHeaderValues(); 
  await fetchPrices();
  
  const initialCoin = document.getElementById("coin").value;
  const initialType = document.getElementById("type").value;
  setPriceByCoin(initialCoin, initialType);
  
  const now = new Date();
  const offset = now.getTimezoneOffset() * 60000;
  const localIsoDate = new Date(now.getTime() - offset).toISOString().slice(0, 16);
  document.getElementById("date-input").value = localIsoDate;

  renderTransactions();
  
  // به‌روزرسانی قیمت‌ها و Summary هر ۶۰ ثانیه
  setInterval(async()=>{
    await fetchPrices();
    renderSummary();
  },60000); 
}

// === Event Listeners (اتصال توابع محاسبه به ورودی‌ها) ===
document.getElementById("submitBtn").addEventListener("click", addTransaction);

// **اتصال جدید:** وقتی مقدار USDT تغییر کند، تعداد توکن محاسبه شود.
document.getElementById("usdt-amount").addEventListener("input", calculateAmountByUSDT); 

// **اتصال جدید:** وقتی تعداد توکن تغییر کند، مقدار USDT محاسبه شود.
document.getElementById("amount").addEventListener("input", calculateUSDTByAmount); 

// **تغییر یافته:** وقتی قیمت تغییر کند، هم محاسبات را مجدد انجام دهیم.
document.getElementById("price").addEventListener("input", calculateAmountByUSDT);

// **تغییر یافته:** وقتی ارز یا نوع تراکنش تغییر کند، قیمت جدید را لود و محاسبات را انجام دهیم.
document.getElementById("coin").addEventListener("change", e => setPriceByCoin(e.target.value, document.getElementById("type").value));
document.getElementById("type").addEventListener("change", e => setPriceByCoin(document.getElementById("coin").value, document.getElementById("type").value));

document.getElementById("searchInput").addEventListener("input", e => renderTransactions(e.target.value));

// 👇 **تابع پشتیبان‌گیری اصلاح شده (شامل investment و cash)**
document.getElementById("backupBtn").addEventListener("click",()=>{
  const backupData = {
      transactions: transactions,
      investment: localStorage.getItem('investment') || '0',
      cash: localStorage.getItem('cash') || '0'
  };
  const dataStr=JSON.stringify(backupData,null,2);
  const blob=new Blob([dataStr],{type:"application/json"});
  const url=URL.createObjectURL(blob);
  const a=document.createElement("a");
  const now=new Date();
  const dateTime=`${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')}_${String(now.getHours()).padStart(2,'0')}-${String(now.getMinutes()).padStart(2,'0')}`;
  a.href=url; 
  a.download=`crypto_account_full_backup_${dateTime}.json`; // نام فایل واضح‌تر
  a.click();
  URL.revokeObjectURL(url);
});

document.getElementById("restoreBtn").addEventListener("click",()=>document.getElementById("restoreFile").click());

// 👇 **تابع بازیابی اصلاح شده (پشتیبانی از ساختار جدید و قدیم)**
document.getElementById("restoreFile").addEventListener("change",e=>{
  const file=e.target.files[0];
  if(!file) return;
  const reader=new FileReader();
  reader.onload=function(evt){
    try{
      const json=JSON.parse(evt.target.result);
      let loadedTransactions = [];
      let loadedInvestment = localStorage.getItem('investment') || '0';
      let loadedCash = localStorage.getItem('cash') || '0';

      // بررسی ساختار جدید (Object شامل transactions, investment, cash)
      if (typeof json === 'object' && json !== null && Array.isArray(json.transactions)) {
          loadedTransactions = json.transactions;
          loadedInvestment = json.investment;
          loadedCash = json.cash;

      // بررسی ساختار قدیمی (فقط Array تراکنش‌ها)
      } else if (Array.isArray(json) && json.every(t => t.coin && t.amount && t.price)) {
          loadedTransactions = json;
          // investment و cash همان مقادیر قبلی localStorage می‌مانند.

      } else {
          alert("فایل انتخاب شده معتبر نیست یا ساختار داده‌ها اشتباه است.");
          return;
      }
      
      transactions=loadedTransactions; 
      transactions.sort((a, b) => new Date(a.date) - new Date(b.date)); 
      saveData(); // ذخیره تراکنش‌های جدید

      // **بروزرسانی مقادیر سرمایه و نقدینگی**
      localStorage.setItem('investment', loadedInvestment);
      localStorage.setItem('cash', loadedCash);

      // به‌روزرسانی نمایش
      loadHeaderValues();
      renderTransactions();
      
      alert("بازیابی پشتیبان با موفقیت انجام شد");

    } catch(err){ 
        alert("خطا در خواندن فایل JSON."); 
        console.error(err); 
    }
  }
  reader.readAsText(file); 
  e.target.value="";
});

init();
</script>
</body>
</html>
