<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Ø¯ÙØªØ± Ø­Ø³Ø§Ø¨ Ø§Ø±Ø² Ø¯ÛŒØ¬ÛŒØªØ§Ù„ Ù¾ÛŒØ´Ø±ÙØªÙ‡</title>
<style>
body {
  font-family: Tahoma, sans-serif;
  background: #111;
  color: #eee;
  margin: 20px auto;
  max-width: 800px;
  padding: 0 10px 40px; 
}
h2, h3 { color: #0f0; text-align: center; margin-top: 25px; }
h2 { margin-bottom: 30px; }

/* === Ø§Ø³ØªØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø¹Ù…ÙˆÙ…ÛŒ ÙØ±Ù… === */
.form-container {
  display: flex;
  flex-wrap: wrap;
  gap: 10px; 
  padding: 15px;
  background: #222;
  border-radius: 8px;
  margin-bottom: 20px;
}
.form-item {
  flex: 1 1 45%; 
  min-width: 150px;
}
.full-width { flex: 1 1 100%; }

label {
  display: block; 
  margin-bottom: 4px; 
  font-weight: bold; 
  font-size: 14px;
}
select, input:not([type="file"]), button {
  display: block; 
  width: 100%; 
  font-size: 14px;
  padding: 8px; 
  border-radius: 6px; 
  border: none; 
  box-sizing: border-box;
  margin-top: 0; 
}
input:not([type="file"]) { background: #333; color: #eee; }

button { 
  background-color: #0f0; 
  color: #000; 
  font-weight: bold; 
  cursor: pointer;
  transition: background-color 0.2s;
}
button:hover { background-color: #0c0; }

#submitBtn { margin-top: 20px; padding: 10px; }

/* === Ø¨Ø®Ø´ Ø®Ù„Ø§ØµÙ‡ Ø¨Ø§Ù„Ø§ (Header) === */
.top-summary {
    background: #222;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 20px;
    border: 1px solid #444;
}
.summary-line {
    display: flex;
    justify-content: space-between;
    padding: 5px 0;
    border-bottom: 1px dashed #333;
}
.summary-line:last-child {
    border-bottom: none;
    font-size: 1.1em;
}
.summary-label {
    color: #aaa;
    font-weight: normal;
}
.summary-value {
    font-weight: bold;
    color: #fff;
    direction: ltr; /* Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ Ø¹Ø¯Ø¯ Ùˆ ÙˆØ§Ø­Ø¯ Ø¨Ù‡ ØµÙˆØ±Øª Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ */
    text-align: left;
}
#total-assets-display-value { color: orange; font-size: 1.2em; }
#last-updated { font-size: 0.7em; color: #aaa; margin-top: 10px; text-align: center; }
.profit-text { color: #0f0 !important; }
.loss-text { color: #f33 !important; }

/* === Ø¨Ø®Ø´ ÙˆØ±ÙˆØ¯ÛŒ Ø³Ø±Ù…Ø§ÛŒÙ‡/Ù†Ù‚Ø¯ === */
.input-summary-section {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin-bottom: 20px;
    padding: 10px;
    background: #333;
    border-radius: 8px;
}
.input-summary-box {
    flex: 1 1 45%;
    min-width: 200px;
    padding: 5px;
}
.input-group { 
    display: flex; 
    align-items: center; 
    margin-top: 5px; 
    gap: 5px;
}
.input-summary-box input { margin: 0; text-align: center; padding: 6px; font-size: 13px; }
.input-summary-box button { width: auto; padding: 6px 10px; font-size: 12px; margin: 0; flex-shrink: 0; }

/* === Ø§Ø³ØªØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø¬Ø¯ÙˆÙ„ === */
.table-container {
  overflow-x: auto; 
  margin-top: 15px; 
  background: #222;
  border-radius: 6px; 
  padding: 5px; 
  animation: slide-in 0.5s ease;
}
@keyframes slide-in { from { opacity: 0; } to { opacity: 1; } }

.table-container table {
  width: 100%; 
  border-collapse: collapse; 
  min-width: 750px; /* Ø§ÙØ²Ø§ÛŒØ´ Ø¹Ø±Ø¶ Ø¨Ø±Ø§ÛŒ Ø¬Ø§ÛŒ Ø¯Ø§Ø¯Ù† Ø³ØªÙˆÙ†â€ŒÙ‡Ø§ÛŒ Ø¬Ø¯ÛŒØ¯ Ùˆ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ */
}
.table-container th,
.table-container td {
  border: 1px solid #444; 
  padding: 3px 5px;   /* Ú©Ø§Ù‡Ø´ Ù¾Ø¯ÛŒÙ†Ú¯ */
  font-size: 13px;    
  text-align: center; 
  word-break: break-word; 
  line-height: 1.4;  
}
.table-container th { background-color: #333; }
.table-container tbody tr:hover { background-color: #333a; }

/* === Ø¹Ø±Ø¶ Ø³ØªÙˆÙ† Ù†ÙˆØ¹ === */
.type-cell {
    width: 60px; 
    font-weight: bold;
}

/* === Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ø¹Ù…Ù„ÛŒØ§Øª Ø¬Ø¯ÙˆÙ„ === */
.actions-cell {
  white-space: nowrap; 
  width: 1px; 
}
.actions-cell button {
  display: inline-block;
  width: auto;
  padding: 2px 5px;     
  font-size: 10px;       
  height: auto;         
  margin: 1px;
  border-radius: 4px;
}
button.edit { background-color: orange; color: black; }
button.delete { background-color: red; color: white; }

/* === Ø±Ù†Ú¯â€ŒÙ‡Ø§ÛŒ Ø³ÙˆØ¯ Ùˆ Ø²ÛŒØ§Ù† Ø¬Ø¯ÙˆÙ„ === */
.profit { color: #0f0; font-weight: bold; }
.loss { color: #f33; font-weight: bold; }
.buy { color: #0ff; }
.sell { color: #f0f; }

/* === Ø³Ø§ÛŒØ± Ø§Ø³ØªØ§ÛŒÙ„â€ŒÙ‡Ø§ === */
#costDisplay { color:#0f0; font-weight:bold; margin-top:-5px; margin-bottom:12px; text-align: center; }
#searchInput { background: #333; margin-top: 10px; }

/* === Ø±Ø³Ù¾Ø§Ù†Ø³ÛŒÙˆ Ø¨Ø±Ø§ÛŒ Ù…ÙˆØ¨Ø§ÛŒÙ„ === */
@media (max-width: 600px) {
  body { margin: 5px; padding: 0 5px 40px; }
  .form-container { flex-direction: column; }
  .form-item { min-width: 100%; }
  .table-container table { min-width: 500px; } 
  .table-container th,
  .table-container td { padding: 3px 6px; font-size: 12px; }
  .actions-cell button { font-size: 9px; padding: 1px 4px; }
  .input-summary-section { flex-direction: column; }
  .input-summary-box { min-width: 100%; }
}
</style>
</head>
<body>

<h2>ğŸ“’ Ø¯ÙØªØ± Ø­Ø³Ø§Ø¨ Ø§Ø±Ø² Ø¯ÛŒØ¬ÛŒØªØ§Ù„ Ù¾ÛŒØ´Ø±ÙØªÙ‡</h2>

<div class="top-summary">
    <div class="summary-line">
        <span class="summary-label">Ø³Ø±Ù…Ø§ÛŒÙ‡â€ŒÚ¯Ø°Ø§Ø±ÛŒ Ø§ÙˆÙ„ÛŒÙ‡ (USDT):</span>
        <span class="summary-value" id="investment-display-value">0 USDT</span>
    </div>
    <div class="summary-line">
        <span class="summary-label">ØªØªØ± Ù†Ù‚Ø¯ (USDT):</span>
        <span class="summary-value" id="cash-display-value">0 USDT</span>
    </div>
    <div class="summary-line">
        <span class="summary-label">Ø§Ø±Ø²Ø´ Ú©Ù„ Ø¯Ø§Ø±Ø§ÛŒÛŒâ€ŒÙ‡Ø§ (USDT) ğŸ’°:</span>
        <span class="summary-value" id="total-assets-display-value">0 USDT</span>
    </div>
    <div class="summary-line">
        <span class="summary-label">Ø³ÙˆØ¯/Ø²ÛŒØ§Ù† Ú©Ù„ (USDT) ğŸ“ˆ:</span>
        <span class="summary-value" id="total-profit-value">0 USDT</span>
    </div>
    <div class="summary-line">
        <span class="summary-label">Ø¯Ø±ØµØ¯ Ø³ÙˆØ¯/Ø²ÛŒØ§Ù† Ú©Ù„ (%):</span>
        <span class="summary-value" id="total-profit-percent">0%</span>
    </div>
    <div id="last-updated">Ø¢Ø®Ø±ÛŒÙ† Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù‚ÛŒÙ…Øªâ€ŒÙ‡Ø§: -</div>
</div>

<div class="input-summary-section">
  <div class="input-summary-box">
    <label for="investment-input">Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø³Ø±Ù…Ø§ÛŒÙ‡â€ŒÚ¯Ø°Ø§Ø±ÛŒ Ø§ÙˆÙ„ÛŒÙ‡</label>
    <div class="input-group">
      <input type="number" id="investment-input" placeholder="Ù…Ø¨Ù„Øº Ú©Ù„ Ø³Ø±Ù…Ø§ÛŒÙ‡">
      <button onclick="updateHeaderValue('investment')">Ø«Ø¨Øª</button>
    </div>
  </div>
  <div class="input-summary-box">
    <label for="cash-input">Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ ØªØªØ± Ù†Ù‚Ø¯</label>
    <div class="input-group">
      <input type="number" id="cash-input" placeholder="Ù…ÙˆØ¬ÙˆØ¯ÛŒ ØªØªØ± Ù†Ù‚Ø¯">
      <button onclick="updateHeaderValue('cash')">Ø«Ø¨Øª</button>
    </div>
  </div>
</div>

<div class="form-container">
  <div class="form-item">
    <label for="coin">Ø§Ù†ØªØ®Ø§Ø¨ Ø§Ø±Ø²:</label>
    <select id="coin">
      <option value="BTC">BTC</option>
      <option value="ETH">ETH</option>
      <option value="CRV">CRV</option>
      <option value="ADA">ADA</option>
      <option value="DOGE">DOGE</option>
            <option value="PUMP">PUMP</option>
      <option value="BLUM">BLUM</option>
        <option value="BLUM1">BLUM1</option>

    </select>
  </div>
  <div class="form-item">
    <label for="type">Ù†ÙˆØ¹ ØªØ±Ø§Ú©Ù†Ø´:</label>
    <select id="type">
      <option value="buy">Ø®Ø±ÛŒØ¯</option>
      <option value="sell">ÙØ±ÙˆØ´</option>
    </select>
  </div>
  <div class="form-item">
    <label for="price">Ù‚ÛŒÙ…Øª ÙˆØ§Ø­Ø¯ (USDT):</label>
    <input type="number" id="price" placeholder="Ù‚ÛŒÙ…Øª ÙˆØ§Ø­Ø¯" step="0.0001" min="0">
  </div>
  <div class="form-item">
    <label for="usdt-amount">Ù…Ù‚Ø¯Ø§Ø± ØªØªØ± (USDT):</label>
    <input type="number" id="usdt-amount" placeholder="Ù…Ù‚Ø¯Ø§Ø± USDT" step="0.01" min="0">
  </div>
  <div class="form-item">
    <label for="amount">ØªØ¹Ø¯Ø§Ø¯ ØªÙˆÚ©Ù†:</label>
    <input type="number" id="amount" placeholder="ØªØ¹Ø¯Ø§Ø¯" step="0.0001" min="0">
  </div>
  <div class="form-item full-width">
    <label for="date-input">ØªØ§Ø±ÛŒØ® Ùˆ Ø³Ø§Ø¹Øª ØªØ±Ø§Ú©Ù†Ø´:</label>
    <input type="datetime-local" id="date-input" />
  </div>

  <div id="costDisplay" class="full-width">Ù‚ÛŒÙ…Øª ØªÙ…Ø§Ù… Ø´Ø¯Ù‡: 0</div>
  
  <div class="form-item full-width">
    <button id="submitBtn">Ø«Ø¨Øª ØªØ±Ø§Ú©Ù†Ø´</button>
  </div>

  <div class="form-item">
    <button id="backupBtn">Ø¯Ø§Ù†Ù„ÙˆØ¯ Ù¾Ø´ØªÛŒØ¨Ø§Ù†</button>
  </div>
  <div class="form-item">
    <input type="file" id="restoreFile" style="display:none" accept=".json" />
    <button id="restoreBtn">Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù¾Ø´ØªÛŒØ¨Ø§Ù†</button>
  </div>
</div>

<h3>Ø¬Ø³ØªØ¬Ùˆ Ø¯Ø± ØªØ±Ø§Ú©Ù†Ø´â€ŒÙ‡Ø§ (Ø¨Ø± Ø§Ø³Ø§Ø³ Ø§Ø±Ø²):</h3>
<input type="text" id="searchInput" placeholder="Ù†Ø§Ù… Ø§Ø±Ø² Ø±Ø§ ØªØ§ÛŒÙ¾ Ú©Ù†ÛŒØ¯ ...">

<div id="transactionsContainer" class="table-container"></div>

<h3>Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ùˆ Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† Ø®Ø±ÛŒØ¯</h3>
<div class="table-container">
<table id="summaryTable">
  <thead>
    <tr>
      <th>Ø§Ø±Ø²</th>
      <th>Ù…ÙˆØ¬ÙˆØ¯ÛŒ</th>
      <th>Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† Ø®Ø±ÛŒØ¯</th>
      <th>Ù‚ÛŒÙ…Øª ØªÙ…Ø§Ù… Ø´Ø¯Ù‡</th>
      <th>Ù‚ÛŒÙ…Øª Ù„Ø­Ø¸Ù‡â€ŒØ§ÛŒ</th>
      <th>Ø§Ø±Ø²Ø´ ÙØ¹Ù„ÛŒ</th>
      <th>Ø³ÙˆØ¯/Ø²ÛŒØ§Ù† Ù„Ø­Ø¸Ù‡â€ŒØ§ÛŒ</th>
      <th>Ø¯Ø±ØµØ¯ Ø³ÙˆØ¯/Ø²ÛŒØ§Ù† Ù„Ø­Ø¸Ù‡â€ŒØ§ÛŒ</th>
    </tr>
  </thead>
  <tbody id="summary"></tbody>
</table>
</div>

<script>
// === Ù…ØªØºÛŒØ±Ù‡Ø§ÛŒ Ø³Ø±Ø§Ø³Ø±ÛŒ ===
let transactions = JSON.parse(localStorage.getItem("transactions") || "[]");
let editIndex = -1;
let prices = {};

// Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Coingecko API
const coinGeckoIds = {
  BTC: "bitcoin", ETH: "ethereum", CRV: "curve-dao-token",
  ADA: "cardano",   DOGE: "dogecoin", PUMP:"pump-fun",
  BLUM: "blum",BLUM1: "blum"
};

/**
 * ØªØ¹ÛŒÛŒÙ† Ø±Ù‚Ù… Ø§Ø¹Ø´Ø§Ø± Ø¨Ø± Ø§Ø³Ø§Ø³ Ù‚ÛŒÙ…Øª.
 * Ø§Ú¯Ø± Ù‚ÛŒÙ…Øª > 1 Ø¨Ø§Ø´Ø¯ØŒ 2 Ø±Ù‚Ù… Ø§Ø¹Ø´Ø§Ø±.
 * Ø§Ú¯Ø± Ù‚ÛŒÙ…Øª <= 1 Ø¨Ø§Ø´Ø¯ØŒ 5 Ø±Ù‚Ù… Ø§Ø¹Ø´Ø§Ø±.
 */
function getDecimals(price) {
    return price > 1 ? 2 : 5;
}

// === ØªÙˆØ§Ø¨Ø¹ API Ùˆ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ ===
async function fetchPrices() {
  const ids = Object.values(coinGeckoIds).join(",");
  try {
    // Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Coingecko API (Ø¨Ø¯ÙˆÙ† Ù†ÛŒØ§Ø² Ø¨Ù‡ Ù¾Ø±ÙˆÚ©Ø³ÛŒ)
    const res = await fetch(`https://api.coingecko.com/api/v3/simple/price?ids=${ids}&vs_currencies=usd`);
    const data = await res.json();
    for (const [key, id] of Object.entries(coinGeckoIds)) {
      prices[key] = data[id]?.usd || 0;
    }
    const now = new Date();
    document.getElementById('last-updated').textContent = `Ø¢Ø®Ø±ÛŒÙ† Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù‚ÛŒÙ…Øªâ€ŒÙ‡Ø§: ${now.toLocaleTimeString('fa-IR', {hour: '2-digit', minute: '2-digit'})}`;
  } catch(error) { 
    console.error("Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ù‚ÛŒÙ…Øª Ø§Ø² Coingecko:", error);
    for (const key in coinGeckoIds) prices[key]=0; 
  }
}

function saveData(){ localStorage.setItem("transactions", JSON.stringify(transactions)); }

// *** ØªØ§Ø¨Ø¹ Ø¨Ù‡â€ŒØ±ÙˆØ² Ø´Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ Ù‚ÛŒÙ…Øª ØªÙ…Ø§Ù… Ø´Ø¯Ù‡ ***
function updateCostDisplay() {
  const usdtAmount = parseFloat(document.getElementById("usdt-amount").value);
  const amount = parseFloat(document.getElementById("amount").value);
  
  let cost = 0;
  if (!isNaN(usdtAmount) && usdtAmount > 0) {
    cost = usdtAmount.toFixed(2);
  } else if (!isNaN(amount) && amount > 0) {
    const price = parseFloat(document.getElementById("price").value);
    if (!isNaN(price) && price > 0) {
      cost = (amount * price).toFixed(2);
    }
  }
  
  document.getElementById("costDisplay").textContent = `Ù‚ÛŒÙ…Øª ØªÙ…Ø§Ù… Ø´Ø¯Ù‡: ${parseFloat(cost).toLocaleString('fa-IR')} USDT`;
}

// *** ØªØ§Ø¨Ø¹ Ø¬Ø¯ÛŒØ¯: Ù…Ø­Ø§Ø³Ø¨Ù‡ ØªØ¹Ø¯Ø§Ø¯ ØªÙˆÚ©Ù† Ø¨Ø± Ø§Ø³Ø§Ø³ Ù…Ù‚Ø¯Ø§Ø± USDT ***
function calculateAmountByUSDT() {
    const usdt = parseFloat(document.getElementById("usdt-amount").value);
    const price = parseFloat(document.getElementById("price").value);
    const amountInput = document.getElementById("amount");
    
    // Ø§Ú¯Ø± ÛŒÚ©ÛŒ Ø§Ø² Ù…Ù‚Ø§Ø¯ÛŒØ± ØµÙØ± ÛŒØ§ Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø¨Ø§Ø´Ø¯
    if (isNaN(usdt) || usdt <= 0 || isNaN(price) || price <= 0) {
        amountInput.value = '';
        updateCostDisplay();
        return;
    }

    // Ù…Ø­Ø§Ø³Ø¨Ù‡: ØªØ¹Ø¯Ø§Ø¯ ØªÙˆÚ©Ù† = Ù…Ù‚Ø¯Ø§Ø± USDT / Ù‚ÛŒÙ…Øª ÙˆØ§Ø­Ø¯
    const amount = usdt / price;
    
    // Ø§Ø¹Ù…Ø§Ù„ Ù…Ù†Ø·Ù‚ Ø§Ø¹Ø´Ø§Ø± Ø¨Ø±Ø§ÛŒ ØªØ¹Ø¯Ø§Ø¯ (Ø­Ø¯Ø§Ù‚Ù„ 5 Ø±Ù‚Ù… Ø§Ø¹Ø´Ø§Ø± Ø¨Ø±Ø§ÛŒ Ø¯Ù‚Øª)
    amountInput.value = amount.toFixed(5);
    
    updateCostDisplay();
}

// *** ØªØ§Ø¨Ø¹ Ø¬Ø¯ÛŒØ¯: Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù…Ù‚Ø¯Ø§Ø± USDT Ø¨Ø± Ø§Ø³Ø§Ø³ ØªØ¹Ø¯Ø§Ø¯ ØªÙˆÚ©Ù† (Ø¨Ø±Ø§ÛŒ Ù…Ø¯ÛŒØ±ÛŒØª ÙˆØ±ÙˆØ¯ÛŒ) ***
function calculateUSDTByAmount() {
    const amount = parseFloat(document.getElementById("amount").value);
    const price = parseFloat(document.getElementById("price").value);
    const usdtInput = document.getElementById("usdt-amount");

    // Ø§Ú¯Ø± ÛŒÚ©ÛŒ Ø§Ø² Ù…Ù‚Ø§Ø¯ÛŒØ± ØµÙØ± ÛŒØ§ Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø¨Ø§Ø´Ø¯
    if (isNaN(amount) || amount <= 0 || isNaN(price) || price <= 0) {
        usdtInput.value = '';
        updateCostDisplay();
        return;
    }

    // Ù…Ø­Ø§Ø³Ø¨Ù‡: Ù…Ù‚Ø¯Ø§Ø± USDT = ØªØ¹Ø¯Ø§Ø¯ ØªÙˆÚ©Ù† * Ù‚ÛŒÙ…Øª ÙˆØ§Ø­Ø¯
    const usdt = amount * price;

    usdtInput.value = usdt.toFixed(2); // USDT Ù…Ø¹Ù…ÙˆÙ„Ø§ ØªØ§ 2 Ø±Ù‚Ù… Ø§Ø¹Ø´Ø§Ø±
    
    updateCostDisplay();
}


// === ØªÙˆØ§Ø¨Ø¹ Ø±Ù†Ø¯Ø±ÛŒÙ†Ú¯ ===
function renderTransactions(filterText = "") {
  const container = document.getElementById("transactionsContainer");
  container.innerHTML = "";
  
  const grouped = transactions.reduce((acc, t, i) => {
    if(filterText && !t.coin.toLowerCase().includes(filterText.toLowerCase())) return acc;
    if(!acc[t.coin]) acc[t.coin] = [];
    acc[t.coin].push({...t, index: i});
    return acc;
  }, {});
  
  for (const coin in grouped) {
    const tableContainer = document.createElement("div");
    tableContainer.className = "table-container";
    const table = document.createElement("table");
    table.innerHTML = `
      <thead>
        <tr><th colspan="7" style="background:#444;color:#0f0;font-size:1.1em;">${coin}</th></tr>
        <tr>
          <th>ØªØ¹Ø¯Ø§Ø¯</th><th>Ù‚ÛŒÙ…Øª ÙˆØ§Ø­Ø¯</th><th>Ù‚ÛŒÙ…Øª ØªÙ…Ø§Ù… Ø´Ø¯Ù‡</th>
          <th class="type-cell">Ù†ÙˆØ¹</th><th>Ø³ÙˆØ¯/Ø²ÛŒØ§Ù† ÙØ±ÙˆØ´</th><th>ØªØ§Ø±ÛŒØ® Ùˆ Ø³Ø§Ø¹Øª</th><th>Ø¹Ù…Ù„ÛŒØ§Øª</th>
        </tr>
      </thead>
      <tbody></tbody>`;
    const tbody = table.querySelector("tbody");

    grouped[coin].slice().reverse().forEach(t => {
      const cost = (t.amount * t.price).toFixed(2);
      
      const options = { year: 'numeric', month: 'numeric', day: 'numeric', hour: '2-digit', minute: '2-digit', hour12: false };
      let formattedDate = t.date ? new Date(t.date).toLocaleString("fa-IR", options).replace(',', '<br>') : "-";

      let profitLossSale = "";
      let profitLossClass = "";
      if (t.type === "sell") {
          const { avg } = calculateAvg(t.coin, t.index); 
          if (avg > 0) {
            profitLossSale = ((t.price - avg) * t.amount).toFixed(2);
            profitLossClass = profitLossSale >= 0 ? "profit" : "loss";
          }
      }
      
      // *** Ø§Ø¹Ù…Ø§Ù„ Ù…Ù†Ø·Ù‚ Ø§Ø¹Ø´Ø§Ø± Ø¨Ø±Ø§ÛŒ Ù‚ÛŒÙ…Øª ÙˆØ§Ø­Ø¯ (t.price) ***
      const priceDecimals = getDecimals(t.price); 

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${t.amount.toFixed(2)}</td>
        <td>${t.price.toFixed(priceDecimals)}</td> 
        <td>${cost.toLocaleString('fa-IR')}</td>
        <td class="type-cell ${t.type}">${t.type === "buy" ? "Ø®Ø±ÛŒØ¯" : "ÙØ±ÙˆØ´"}</td>
        <td class="${profitLossClass}">${profitLossSale.toLocaleString('fa-IR')}</td>
        <td>${formattedDate}</td>
        <td class="actions-cell">
          <button class="edit" onclick="editTransaction(${t.index})">ÙˆÛŒØ±Ø§ÛŒØ´</button> 
          <button class="delete" onclick="deleteTransaction(${t.index})">Ø­Ø°Ù</button>
        </td>`;
      tbody.appendChild(tr);
    });

    tableContainer.appendChild(table);
    container.appendChild(tableContainer);
  }

  renderSummary();
}

// Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ùˆ Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† Ø®Ø±ÛŒØ¯ ØªØ§ ÛŒÚ© Ù†Ù‚Ø·Ù‡ Ù…Ø´Ø®Øµ Ø¯Ø± Ù„ÛŒØ³Øª ØªØ±Ø§Ú©Ù†Ø´â€ŒÙ‡Ø§
function calculateHoldings(untilIndex = transactions.length) {
    const holdings = {};
    for (let i = 0; i < untilIndex; i++) {
        const t = transactions[i];
        if (!holdings[t.coin]) holdings[t.coin] = { amount: 0, cost: 0 };

        if (t.type === "buy") {
            holdings[t.coin].amount += t.amount;
            holdings[t.coin].cost += t.amount * t.price;
        } else {
            const avg = holdings[t.coin].cost / holdings[t.coin].amount || 0;
            holdings[t.coin].amount -= t.amount;
            holdings[t.coin].cost -= avg * t.amount;
            if (holdings[t.coin].amount < 0.00001) {
                holdings[t.coin].amount = 0;
                holdings[t.coin].cost = 0;
            }
        }
    }
    return holdings;
}

// ØªØ§Ø¨Ø¹ Ú©Ù…Ú©ÛŒ Ø¨Ø±Ø§ÛŒ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† Ø®Ø±ÛŒØ¯ Ù‚Ø¨Ù„ Ø§Ø² ÛŒÚ© ØªØ±Ø§Ú©Ù†Ø´ (Ø¨Ø±Ø§ÛŒ ÙØ±ÙˆØ´)
function calculateAvg(coin, currentIndex) {
    const holdings = calculateHoldings(currentIndex);
    const amt = holdings[coin]?.amount || 0;
    const cost = holdings[coin]?.cost || 0;
    return { avg: cost / amt || 0, cost, amt };
}

function renderSummary(){
  const tbody=document.getElementById("summary");
  tbody.innerHTML="";
  const holdings=calculateHoldings();

  let totalCost=0,totalValue=0,totalProfit=0;

  for(const coin in holdings){
    const amt = holdings[coin].amount;
    if(amt<=0.00001) continue;
    const avg = holdings[coin].cost/amt;
    const cost = holdings[coin].cost;
    const currentPrice = prices[coin]||0;
    const value = currentPrice * amt;
    const profitLoss = value - cost;
    const profitLossPercent = cost > 0 ? (profitLoss / cost) * 100 : 0;
    const profitLossClass = profitLoss>=0?"profit":"loss";

    totalCost += cost;
    totalValue += value;
    totalProfit += profitLoss;

    // *** Ø§Ø¹Ù…Ø§Ù„ Ù…Ù†Ø·Ù‚ Ø§Ø¹Ø´Ø§Ø± Ø¨Ø±Ø§ÛŒ Ù‚ÛŒÙ…Øª Ù„Ø­Ø¸Ù‡â€ŒØ§ÛŒ (currentPrice) ***
    const priceDecimals = getDecimals(currentPrice); 

    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td>${coin}</td>
      <td>${amt.toFixed(2)}</td>
      <td>${avg.toFixed(5)}</td>
      <td>${cost.toFixed(2).toLocaleString('fa-IR')}</td>
      <td>${currentPrice.toFixed(priceDecimals).toLocaleString('fa-IR')}</td>
      <td>${value.toFixed(2).toLocaleString('fa-IR')}</td> <td class="${profitLossClass}">${profitLoss.toFixed(2).toLocaleString('fa-IR')}</td>
      <td class="${profitLossClass}">${profitLossPercent.toFixed(2).toLocaleString('fa-IR')}%</td> `;
    tbody.appendChild(tr);
  }

  // Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø¯Ø±ØµØ¯ Ø³ÙˆØ¯ Ú©Ù„ Ø¯Ø§Ø±Ø§ÛŒÛŒâ€ŒÙ‡Ø§ÛŒ Ø±Ù…Ø²Ù†Ú¯Ø§Ø±ÛŒ (Ø¨Ø¯ÙˆÙ† Ø§Ø­ØªØ³Ø§Ø¨ Ù†Ù‚Ø¯ÛŒÙ†Ú¯ÛŒ)
  const totalAssetsProfitPercent = totalCost > 0 ? (totalProfit / totalCost) * 100 : 0;

  // Ø¬Ù…Ø¹ Ú©Ù„
  const totalInvestment = parseFloat(localStorage.getItem('investment') || '0');
  const cashValue = parseFloat(localStorage.getItem('cash') || '0');
  const totalAssets = totalValue + cashValue;
  const totalInvestmentProfit = totalAssets - totalInvestment;
  const totalInvestmentProfitPercent = totalInvestment > 0 ? (totalInvestmentProfit / totalInvestment) * 100 : 0;
  
  const totalRow=document.createElement("tr");
  totalRow.style.fontWeight="bold";
  totalRow.style.background="#333";
  totalRow.innerHTML=`
    <td colspan="3">Ø¬Ù…Ø¹ Ú©Ù„ Ø¯Ø§Ø±Ø§ÛŒÛŒâ€ŒÙ‡Ø§</td>
    <td>${totalCost.toFixed(2).toLocaleString('fa-IR')}</td> <td>-</td>
    <td>${totalValue.toFixed(2).toLocaleString('fa-IR')}</td> <td class="${totalProfit>=0?"profit":"loss"}">${totalProfit.toFixed(2).toLocaleString('fa-IR')}</td>
    <td class="${totalAssetsProfitPercent>=0?"profit":"loss"}">${totalAssetsProfitPercent.toFixed(2).toLocaleString('fa-IR')}%</td>`; tbody.appendChild(totalRow);
  
  const profitClass = totalInvestmentProfit >= 0 ? 'profit-text' : 'loss-text';

  // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù…Ù‚Ø§Ø¯ÛŒØ± Ø¨Ø§Ù„Ø§ÛŒ Ø¬Ø¯ÙˆÙ„ (Ø®Ù„Ø§ØµÙ‡ Ú©Ù„ÛŒ Ø­Ø³Ø§Ø¨)
  document.getElementById('total-assets-display-value').textContent = `${totalAssets.toFixed(2).toLocaleString('fa-IR')} USDT`;
  
  // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø³ÙˆØ¯ Ú©Ù„
  const profitValueEl = document.getElementById('total-profit-value');
  const profitPercentEl = document.getElementById('total-profit-percent');
  
  profitValueEl.textContent = `${totalInvestmentProfit.toFixed(2).toLocaleString('fa-IR')} USDT`;
  profitPercentEl.textContent = `${totalInvestmentProfitPercent.toFixed(2).toLocaleString('fa-IR')}%`;
  
  // ØªÙ†Ø¸ÛŒÙ… Ø±Ù†Ú¯ Ø³ÙˆØ¯/Ø²ÛŒØ§Ù†
  profitValueEl.className = `summary-value ${profitClass}`;
  profitPercentEl.className = `summary-value ${profitClass}`;

  // Ù„ÙˆØ¯ Ú©Ø±Ø¯Ù† Ù…Ø¬Ø¯Ø¯ Ù…Ù‚Ø§Ø¯ÛŒØ± Ø§ØµÙ„ÛŒ Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´
  loadHeaderValues();
}

// === ØªÙˆØ§Ø¨Ø¹ Ù…Ø¯ÛŒØ±ÛŒØª ØªØ±Ø§Ú©Ù†Ø´â€ŒÙ‡Ø§ ===
function addTransaction(){
  const coin = document.getElementById("coin").value;
  // **Ù…Ù‚Ø¯Ø§Ø± ØªØªØ± Ø±Ø§ Ø§Ø² ÙÛŒÙ„Ø¯ usdt-amount Ù…ÛŒâ€ŒØ®ÙˆØ§Ù†ÛŒÙ…**
  let amount = parseFloat(document.getElementById("amount").value);
  let price = parseFloat(document.getElementById("price").value);
  const type = document.getElementById("type").value;
  const dateInput = document.getElementById("date-input").value;
  const usdtAmount = parseFloat(document.getElementById("usdt-amount").value);
  
  // **Ø§ÙˆÙ„ÙˆÛŒØª Ø¨Ø§ Ù…Ù‚Ø¯Ø§Ø± usdt ÙˆØ§Ø±Ø¯ Ø´Ø¯Ù‡ Ø§Ø³Øª**
  if (!isNaN(usdtAmount) && usdtAmount > 0) {
      if (isNaN(price) || price <= 0) {
          alert("Ù„Ø·ÙØ§Ù‹ Ù‚ÛŒÙ…Øª ÙˆØ§Ø­Ø¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.");
          return;
      }
      // Ù…Ø­Ø§Ø³Ø¨Ù‡ ØªØ¹Ø¯Ø§Ø¯ Ø¨Ø± Ø§Ø³Ø§Ø³ ØªØªØ±
      amount = usdtAmount / price;
      // Ù‚ÛŒÙ…Øª ØªÙ…Ø§Ù… Ø´Ø¯Ù‡ (cost) Ø¯Ø± Ø§ÛŒÙ†Ø¬Ø§ Ù‡Ù…Ø§Ù† usdtAmount Ø§Ø³Øª
  }
  
  // **Ø¨Ø±Ø±Ø³ÛŒ Ø§Ø¹ØªØ¨Ø§Ø± Ù†Ù‡Ø§ÛŒÛŒ**
  if(isNaN(amount)||isNaN(price)||amount<=0||price<=0){ 
      alert("Ù…Ù‚Ø§Ø¯ÛŒØ± Ù…Ø¹ØªØ¨Ø± (ØªØ¹Ø¯Ø§Ø¯ ÛŒØ§ ØªØªØ± Ùˆ Ù‚ÛŒÙ…Øª) ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯"); 
      return; 
  }

  // **Ø¨Ø±Ø±Ø³ÛŒ Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ø¨Ø±Ø§ÛŒ ÙØ±ÙˆØ´**
  if(type==="sell"){
    let currentAmount = 0;
    const tempTransactions = editIndex >= 0 ? transactions.filter((_, i) => i !== editIndex) : transactions;
    tempTransactions.forEach(t => {
      if(t.coin === coin) currentAmount += t.type === 'buy' ? t.amount : -t.amount;
    });

    if(amount > currentAmount){ 
      alert(`ÙØ±ÙˆØ´ Ø¨ÛŒØ´ØªØ± Ø§Ø² Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ù…Ø¬Ø§Ø² Ù†ÛŒØ³Øª. Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ø´Ù…Ø§: ${currentAmount.toFixed(4)}`); 
      return; 
    }
  }

  const date = dateInput ? new Date(dateInput).toISOString() : new Date().toISOString();

  // Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø§Ø² Ø§ÛŒÙ†Ú©Ù‡ amount Ùˆ price Ø¯Ù‚ÛŒÙ‚Ø§Ù‹ Ù‡Ù…Ø§Ù† Ú†ÛŒØ²ÛŒ Ù‡Ø³ØªÙ†Ø¯ Ú©Ù‡ Ø«Ø¨Øª Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…
  const newTransaction = { coin, amount: amount, price: price, type, date };

  if(editIndex>=0){
    transactions[editIndex] = newTransaction;
    editIndex = -1;
    document.getElementById("submitBtn").textContent = "Ø«Ø¨Øª ØªØ±Ø§Ú©Ù†Ø´";
  } else { transactions.push(newTransaction); }

  transactions.sort((a, b) => new Date(a.date) - new Date(b.date));

  saveData();
  renderTransactions(document.getElementById("searchInput").value);
  clearForm();
}

function editTransaction(index){
  const t = transactions[index];
  document.getElementById("coin").value = t.coin;
  document.getElementById("amount").value = t.amount;
  document.getElementById("price").value = t.price;
  document.getElementById("type").value = t.type;
  
  // **Ù…Ø­Ø§Ø³Ø¨Ù‡ Ùˆ Ù¾Ø± Ú©Ø±Ø¯Ù† ÙÛŒÙ„Ø¯ usdt-amount Ø¨Ø±Ø§ÛŒ ÙˆÛŒØ±Ø§ÛŒØ´**
  document.getElementById("usdt-amount").value = (t.amount * t.price).toFixed(2);
  
  const date = new Date(t.date);
  const offset = date.getTimezoneOffset() * 60000; 
  const localIsoDate = new Date(date.getTime() - offset).toISOString().slice(0, 16);
  document.getElementById("date-input").value = localIsoDate;

  editIndex = index;
  document.getElementById("submitBtn").textContent = "ÙˆÛŒØ±Ø§ÛŒØ´ ØªØ±Ø§Ú©Ù†Ø´ (Ø«Ø¨Øª ØªØºÛŒÛŒØ±Ø§Øª)";
  updateCostDisplay();
  window.scrollTo(0, 0); 
}

function deleteTransaction(index){
  if(confirm("Ø¢ÛŒØ§ Ø§Ø² Ø­Ø°Ù Ø§ÛŒÙ† ØªØ±Ø§Ú©Ù†Ø´ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ")){
    transactions.splice(index,1);
    saveData();
    renderTransactions(document.getElementById("searchInput").value);
  }
}

function clearForm(){
  document.getElementById("coin").value="BTC";
  document.getElementById("amount").value="";
  document.getElementById("price").value="";
  document.getElementById("usdt-amount").value=""; // Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† ÙÛŒÙ„Ø¯ Ø¬Ø¯ÛŒØ¯
  document.getElementById("type").value="buy";
  document.getElementById("date-input").value = "";
  updateCostDisplay();
  editIndex = -1;
  document.getElementById("submitBtn").textContent="Ø«Ø¨Øª ØªØ±Ø§Ú©Ù†Ø´";
}

function setPriceByCoin(coin, type){
  const currentPrice = prices[coin] || 0;
  if (currentPrice > 0) {
    // *** Ø§Ø¹Ù…Ø§Ù„ Ù…Ù†Ø·Ù‚ Ø§Ø¹Ø´Ø§Ø± Ø¨Ø±Ø§ÛŒ ÙˆØ±ÙˆØ¯ÛŒ Ù‚ÛŒÙ…Øª ***
    const decimals = getDecimals(currentPrice);
    document.getElementById("price").value = currentPrice.toFixed(decimals); 
  } 
  // **Ø¨Ø¹Ø¯ Ø§Ø² Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù‚ÛŒÙ…ØªØŒ Ù…Ø­Ø§Ø³Ø¨Ø§Øª Ø±Ø§ Ø§Ù†Ø¬Ø§Ù… Ù…ÛŒâ€ŒØ¯Ù‡ÛŒÙ…**
  calculateAmountByUSDT(); 
  updateCostDisplay();
}

// === ØªÙˆØ§Ø¨Ø¹ Ø®Ù„Ø§ØµÙ‡ Ø¨Ø§Ù„Ø§ (Header) ===
function updateHeaderValue(type) { 
    const inputEl = document.getElementById(`${type}-input`);
    let value = parseFloat(inputEl.value);

    if (isNaN(value) || value < 0) {
        if(inputEl.value === "") { 
            value = parseFloat(localStorage.getItem(type) || '0');
        } else {
            alert('Ù„Ø·ÙØ§ ÛŒÚ© Ø¹Ø¯Ø¯ Ù…Ø¹ØªØ¨Ø± ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.');
            return;
        }
    }
    
    localStorage.setItem(type, value.toFixed(2)); // Ø°Ø®ÛŒØ±Ù‡ Ø¨Ø§ Ø¯Ù‚Øª 2
    inputEl.value = ''; 
    
    renderSummary(); 
}

function loadHeaderValues() {
    const investment = parseFloat(localStorage.getItem('investment') || '0');
    const cash = parseFloat(localStorage.getItem('cash') || '0');

    // Ù†Ù…Ø§ÛŒØ´ Ù…Ù‚Ø§Ø¯ÛŒØ± Ø¯Ø± Ø¨Ø®Ø´ Ø¬Ø¯ÛŒØ¯ Ø®Ù„Ø§ØµÙ‡ Ø¨Ø§Ù„Ø§ÛŒ Ø¬Ø¯ÙˆÙ„
    document.getElementById('investment-display-value').textContent = `${investment.toFixed(2).toLocaleString('fa-IR')} USDT`;
    document.getElementById('cash-display-value').textContent = `${cash.toFixed(2).toLocaleString('fa-IR')} USDT`;
}


// === Ù…Ù‚Ø¯Ø§Ø±Ø¯Ù‡ÛŒ Ø§ÙˆÙ„ÛŒÙ‡ ===
async function init(){
  loadHeaderValues(); 
  await fetchPrices();
  
  const initialCoin = document.getElementById("coin").value;
  const initialType = document.getElementById("type").value;
  setPriceByCoin(initialCoin, initialType);
  
  const now = new Date();
  const offset = now.getTimezoneOffset() * 60000;
  const localIsoDate = new Date(now.getTime() - offset).toISOString().slice(0, 16);
  document.getElementById("date-input").value = localIsoDate;

  renderTransactions();
  
  // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù‚ÛŒÙ…Øªâ€ŒÙ‡Ø§ Ùˆ Summary Ù‡Ø± Û¶Û° Ø«Ø§Ù†ÛŒÙ‡
  setInterval(async()=>{
    await fetchPrices();
    renderSummary();
  },60000); 
}

// === Event Listeners (Ø§ØªØµØ§Ù„ ØªÙˆØ§Ø¨Ø¹ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø¨Ù‡ ÙˆØ±ÙˆØ¯ÛŒâ€ŒÙ‡Ø§) ===
document.getElementById("submitBtn").addEventListener("click", addTransaction);

// **Ø§ØªØµØ§Ù„ Ø¬Ø¯ÛŒØ¯:** ÙˆÙ‚ØªÛŒ Ù…Ù‚Ø¯Ø§Ø± USDT ØªØºÛŒÛŒØ± Ú©Ù†Ø¯ØŒ ØªØ¹Ø¯Ø§Ø¯ ØªÙˆÚ©Ù† Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø´ÙˆØ¯.
document.getElementById("usdt-amount").addEventListener("input", calculateAmountByUSDT); 

// **Ø§ØªØµØ§Ù„ Ø¬Ø¯ÛŒØ¯:** ÙˆÙ‚ØªÛŒ ØªØ¹Ø¯Ø§Ø¯ ØªÙˆÚ©Ù† ØªØºÛŒÛŒØ± Ú©Ù†Ø¯ØŒ Ù…Ù‚Ø¯Ø§Ø± USDT Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø´ÙˆØ¯.
document.getElementById("amount").addEventListener("input", calculateUSDTByAmount); 

// **ØªØºÛŒÛŒØ± ÛŒØ§ÙØªÙ‡:** ÙˆÙ‚ØªÛŒ Ù‚ÛŒÙ…Øª ØªØºÛŒÛŒØ± Ú©Ù†Ø¯ØŒ Ù‡Ù… Ù…Ø­Ø§Ø³Ø¨Ø§Øª Ø±Ø§ Ù…Ø¬Ø¯Ø¯ Ø§Ù†Ø¬Ø§Ù… Ø¯Ù‡ÛŒÙ….
document.getElementById("price").addEventListener("input", calculateAmountByUSDT);

// **ØªØºÛŒÛŒØ± ÛŒØ§ÙØªÙ‡:** ÙˆÙ‚ØªÛŒ Ø§Ø±Ø² ÛŒØ§ Ù†ÙˆØ¹ ØªØ±Ø§Ú©Ù†Ø´ ØªØºÛŒÛŒØ± Ú©Ù†Ø¯ØŒ Ù‚ÛŒÙ…Øª Ø¬Ø¯ÛŒØ¯ Ø±Ø§ Ù„ÙˆØ¯ Ùˆ Ù…Ø­Ø§Ø³Ø¨Ø§Øª Ø±Ø§ Ø§Ù†Ø¬Ø§Ù… Ø¯Ù‡ÛŒÙ….
document.getElementById("coin").addEventListener("change", e => setPriceByCoin(e.target.value, document.getElementById("type").value));
document.getElementById("type").addEventListener("change", e => setPriceByCoin(document.getElementById("coin").value, document.getElementById("type").value));

document.getElementById("searchInput").addEventListener("input", e => renderTransactions(e.target.value));

// ğŸ‘‡ **ØªØ§Ø¨Ø¹ Ù¾Ø´ØªÛŒØ¨Ø§Ù†â€ŒÚ¯ÛŒØ±ÛŒ Ø§ØµÙ„Ø§Ø­ Ø´Ø¯Ù‡ (Ø´Ø§Ù…Ù„ investment Ùˆ cash)**
document.getElementById("backupBtn").addEventListener("click",()=>{
  const backupData = {
      transactions: transactions,
      investment: localStorage.getItem('investment') || '0',
      cash: localStorage.getItem('cash') || '0'
  };
  const dataStr=JSON.stringify(backupData,null,2);
  const blob=new Blob([dataStr],{type:"application/json"});
  const url=URL.createObjectURL(blob);
  const a=document.createElement("a");
  const now=new Date();
  const dateTime=`${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')}_${String(now.getHours()).padStart(2,'0')}-${String(now.getMinutes()).padStart(2,'0')}`;
  a.href=url; 
  a.download=`crypto_account_full_backup_${dateTime}.json`; // Ù†Ø§Ù… ÙØ§ÛŒÙ„ ÙˆØ§Ø¶Ø­â€ŒØªØ±
  a.click();
  URL.revokeObjectURL(url);
});

document.getElementById("restoreBtn").addEventListener("click",()=>document.getElementById("restoreFile").click());

// ğŸ‘‡ **ØªØ§Ø¨Ø¹ Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ Ø§ØµÙ„Ø§Ø­ Ø´Ø¯Ù‡ (Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ø§Ø² Ø³Ø§Ø®ØªØ§Ø± Ø¬Ø¯ÛŒØ¯ Ùˆ Ù‚Ø¯ÛŒÙ…)**
document.getElementById("restoreFile").addEventListener("change",e=>{
  const file=e.target.files[0];
  if(!file) return;
  const reader=new FileReader();
  reader.onload=function(evt){
    try{
      const json=JSON.parse(evt.target.result);
      let loadedTransactions = [];
      let loadedInvestment = localStorage.getItem('investment') || '0';
      let loadedCash = localStorage.getItem('cash') || '0';

      // Ø¨Ø±Ø±Ø³ÛŒ Ø³Ø§Ø®ØªØ§Ø± Ø¬Ø¯ÛŒØ¯ (Object Ø´Ø§Ù…Ù„ transactions, investment, cash)
      if (typeof json === 'object' && json !== null && Array.isArray(json.transactions)) {
          loadedTransactions = json.transactions;
          loadedInvestment = json.investment;
          loadedCash = json.cash;

      // Ø¨Ø±Ø±Ø³ÛŒ Ø³Ø§Ø®ØªØ§Ø± Ù‚Ø¯ÛŒÙ…ÛŒ (ÙÙ‚Ø· Array ØªØ±Ø§Ú©Ù†Ø´â€ŒÙ‡Ø§)
      } else if (Array.isArray(json) && json.every(t => t.coin && t.amount && t.price)) {
          loadedTransactions = json;
          // investment Ùˆ cash Ù‡Ù…Ø§Ù† Ù…Ù‚Ø§Ø¯ÛŒØ± Ù‚Ø¨Ù„ÛŒ localStorage Ù…ÛŒâ€ŒÙ…Ø§Ù†Ù†Ø¯.

      } else {
          alert("ÙØ§ÛŒÙ„ Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯Ù‡ Ù…Ø¹ØªØ¨Ø± Ù†ÛŒØ³Øª ÛŒØ§ Ø³Ø§Ø®ØªØ§Ø± Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø§Ø´ØªØ¨Ø§Ù‡ Ø§Ø³Øª.");
          return;
      }
      
      transactions=loadedTransactions; 
      transactions.sort((a, b) => new Date(a.date) - new Date(b.date)); 
      saveData(); // Ø°Ø®ÛŒØ±Ù‡ ØªØ±Ø§Ú©Ù†Ø´â€ŒÙ‡Ø§ÛŒ Ø¬Ø¯ÛŒØ¯

      // **Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù…Ù‚Ø§Ø¯ÛŒØ± Ø³Ø±Ù…Ø§ÛŒÙ‡ Ùˆ Ù†Ù‚Ø¯ÛŒÙ†Ú¯ÛŒ**
      localStorage.setItem('investment', loadedInvestment);
      localStorage.setItem('cash', loadedCash);

      // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù†Ù…Ø§ÛŒØ´
      loadHeaderValues();
      renderTransactions();
      
      alert("Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ Ù¾Ø´ØªÛŒØ¨Ø§Ù† Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯");

    } catch(err){ 
        alert("Ø®Ø·Ø§ Ø¯Ø± Ø®ÙˆØ§Ù†Ø¯Ù† ÙØ§ÛŒÙ„ JSON."); 
        console.error(err); 
    }
  }
  reader.readAsText(file); 
  e.target.value="";
});

init();
</script>
</body>
</html>
